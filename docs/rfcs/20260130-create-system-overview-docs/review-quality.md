## Technical Quality Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Approve

**判定基準:** P0 が0件であるため Approve とする。

### 2. 良い点 (Strengths)

- **5.1 既存ドキュメントの内容マッピング**: 16行のマッピング表により、既存ドキュメントの各セクションが新ドキュメントへどう配置されるかが網羅的に整理されている。移行漏れの検出が容易であり、実装フェーズでのチェックリストとしても機能する。備考列に「プロジェクトルート構造を含むよう拡張」「コードベースに基づき全面更新」等の差分情報が付記されている点も実用的である。

- **4. 前提条件・依存関係（既知の乖離点）**: 既存ドキュメントと現行コードベースの乖離を6項目の具体的な対照表として明示している。books テーブルスキーマの差分、配信判定方式の変更（`delivered` boolean から `last_delivered_at IS NULL`）、テーブル数の差異、Web エンドポイントの欠落、`google_books` 設定の欠落、`COPY_PAGE_BASE_URL` の欠落がすべて特定されており、`src/db/init.ts` および `src/server/index.ts` の実装と整合している。これにより、実装者が「何を調査すべきか」を事前に把握でき、Over-engineering を回避したドキュメント作成が可能になる。

- **5.2 新ドキュメントの構成**: 各ドキュメントの構成案がコードブロック内に Markdown 構造として具体的に記載されている。`domain-model.md` において全8テーブル（books, deliveries, delivery_items, job_state, api_usage, prompts, prompt_tokens, collect_cursor）が網羅され、8つのドメイン概念（Book, Job, Delivery, DeliveryItem, Quota, Cursor, Prompt, PromptToken）が定義されている。`api-overview.md` においても `GET /` および `GET /p/:token` の正確なエンドポイントパス、環境変数9項目、`google_books` 必須設定が記載されており、コードベースとの整合性が確保されている。

- **6. 代替案の検討**: 3案を比較し、個人プロジェクトという文脈を踏まえて案A（新規作成＋旧削除）を選定した判断は合理的である。案Bの Git 履歴保持が内容変更の大きさに対して実質無意味であるという分析、案Cの非推奨マーク付き保持が個人プロジェクトでは実益がないという判断は的確である。

- **全体設計のシンプルさ**: ドキュメントのみの変更に閉じた RFC としてスコープが適切に制御されている。コード変更を含まないため、テスト戦略も手動検証6項目に留めており、過剰な複雑さが排除されている。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 定義 |
| :--- | :--- |
| **P0 (Blocker)** | 修正必須。論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 |
| **P1 (Nit)** | 提案。より良い手法、軽微な懸念、参考情報 |

#### 指摘一覧

**[P1-1] `api-overview.md` の GET /p/:token エラーレスポンスの記述精度**

- **対象セクション**: 5.2 新ドキュメントの構成 > `docs/api-overview.md` > Web サーバーエンドポイント
- **内容**: RFC では「期限切れトークン: 410 Gone」「不正トークン: 404 Not Found」と記載されているが、`src/server/routes/prompt.ts` の実装を確認すると、404 が返されるのはトークン文字列の長さが32文字でない場合のみであり、存在しないトークン（長さ32文字だが DB に存在しない）は期限切れと同じく 410 Gone が返される。これは `getPromptByToken` が「トークン未発見」と「期限切れ」の両方で `null` を返し、ルートハンドラが一律 410 を返す実装に起因する。RFC の記述は「不正トークン = 長さ不正のみ 404、それ以外はすべて 410」という実装の正確な反映ではないため、新ドキュメント作成時に実装と齟齬が生じる可能性がある。
- **修正の期待値**: 実装フェーズにおいて、以下のような記述に修正することを推奨する。
  - トークン長不正（32文字以外）: 404 Not Found（HTML エラーページ）
  - トークン未発見または期限切れ: 410 Gone（HTML エラーページ）
  なお、Hono の `notFound` ハンドラ（JSON 形式の 404）は `/p/:token` 以外のパスへのアクセスに対して返されるものであり、トークンの 404 とは別のハンドラである点も明記すると読者の混乱を防げる。

**[P1-2] `architecture.md` の技術スタックにおけるバージョン番号の正確性**

- **対象セクション**: 5.2 新ドキュメントの構成 > `docs/architecture.md` > 技術スタック
- **内容**: RFC では「TypeScript 5.9」「Commander 14.x」「better-sqlite3 12.x」「Nodemailer 7.x」「Hono 4.x」「dotenv 17.x」「Vitest 3.x」と記載されている。`package.json` を確認すると `"typescript": "^5.9.3"`, `"commander": "^14.0.2"`, `"better-sqlite3": "^12.5.0"`, `"nodemailer": "^7.0.12"`, `"hono": "^4.11.4"`, `"dotenv": "^17.2.3"`, `"vitest": "^3.0.0"` であり、RFC の記載は概ね正確である。ただし、`@types/node` が `"^25.0.3"` であることから Node.js のターゲットバージョン（v25 相当の型定義を使用）が推測されるが、RFC の技術スタックには Node.js のバージョン要件が明示されていない。
- **修正の期待値**: 新ドキュメント作成時に、Node.js のバージョン要件（`@types/node` の設定や `tsconfig.json` の `target` に基づく）を技術スタックに含めることを推奨する。運用上のバージョン固定情報として有用である。

**[P1-3] テスト戦略における DBスキーマ整合性検証の具体的手順が未定義**

- **対象セクション**: 8. テスト戦略
- **内容**: 検証項目に「新ドキュメントの DB スキーマ記述が `src/db/init.ts` の `initSchema` と整合していること」とあるが、この検証の具体的な手順（目視確認か、スクリプトによる突合か）が定義されていない。8テーブルのスキーマを手動で突合する作業は漏れが生じやすい。
- **修正の期待値**: 検証手順として「`src/db/init.ts` の `initSchema` 関数内の CREATE TABLE 文と、`domain-model.md` の各テーブル定義を1テーブルずつ目視で照合する」旨を明記するか、あるいは実装者に検証方法の裁量を委ねる場合はその旨を記載することを推奨する。ドキュメント専用の RFC であるため自動化は不要だが、手順の明確化は品質担保に寄与する。

**[P1-4] `arch.md` の「状態遷移の不変条件」セクションの陳腐化情報の扱い**

- **対象セクション**: 5.1 既存ドキュメントの内容マッピング
- **内容**: マッピング表では `arch.md > 状態遷移の不変条件` を `domain-model.md` に移行するとされている。現行の `arch.md` には「`delivered` は `false` → `true` への遷移のみ」と記載されているが、実際のコードでは `delivered` boolean フラグは廃止され `last_delivered_at` タイムスタンプによる判定に変更されている。この陳腐化した情報がそのまま移行されないよう注意が必要である。RFC のセクション5.2 の `domain-model.md` 構成案では「未配信（last_delivered_at IS NULL）→ 配信済み（last_delivered_at にタイムスタンプ設定）」と正しく記載されているため、実装時に構成案に従えば問題は発生しない。
- **修正の期待値**: 本指摘は注意喚起に留まる。マッピング表の備考列に「`delivered` boolean は廃止済み。`last_delivered_at` タイムスタンプ判定に更新すること」と付記すると、実装者にとっての安全網となる。
