## Approach Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Request Changes

**判定基準:** P0 が1件以上存在するため Request Changes とする。

### 2. 良い点 (Strengths)

- **セクション 6（代替案の検討）**: テンプレートを TypeScript 埋め込みではなく独立 Markdown + YAML として配置する判断は妥当である。テンプレートは「実装契約」であり、コードとの関心分離・視認性・編集容易性を優先する根拠が明確に示されている。
- **セクション 3（Non-Goals）**: LLM API 呼び出しの実装、DB スキーマ変更、生成品質チューニングを明確にスコープ外としている。テンプレート登録と実装を分離することで、変更の影響範囲を最小化し、レビュー可能な粒度に保つ判断は適切である。
- **セクション 7.4（マイグレーションと後方互換性）**: 新規ファイル追加のみで既存コード・DB・API への変更がないことを明示しており、ロールバックもファイル削除のみで完了する点は低リスクである。
- **セクション 5.6（テスト設計）**: テンプレートの破壊検知（空ファイル検知、変数プレースホルダ規約違反検知、必須構造検証）をテストで担保する方針は、コンパイル時検証がない代替案 B の弱点を適切に補完している。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 定義 |
| :--- | :--- |
| **P0 (Blocker)** | 修正必須。論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 |
| **P1 (Nit)** | 提案。より良い手法、軽微な懸念、参考情報 |

#### 指摘一覧

**[P0-1] 変数規約とテンプレート用途の不整合 — `{{book.authors}}` の型曖昧性**
- **対象セクション**: 5.2 テンプレート設計 > 変数規約（全テンプレート共通）
- **内容**: RFC では変数 `{{book.authors}}` を定義し、これが `Book` 型の `authors_json` に対応すると記載している。しかし `authors_json` は JSON 文字列（`string | null`）であり、テンプレートの差し込み変数として利用するには JSON パース後の整形が必要である。既存の `prompt-builder.ts` は `getBookAuthors()` で JSON パースし `join(", ")` で整形しているが、新テンプレートの `{{book.authors}}` がどの形式（JSON 文字列そのまま / カンマ区切り文字列 / 配列）で差し込まれるのか、RFC に仕様が記載されていない。テンプレートが SoT であるなら、差し込み時のデータ変換仕様もテンプレート規約に含めるべきである。これが未定義のまま登録すると、将来の実装者がテンプレートと実装の間で不整合を起こすリスクがある。
- **修正の期待値**: 各変数について、差し込み時のデータ型・整形ルールを変数規約に明記すること。例: `{{book.authors}}` は「`authors_json` を JSON パースし、カンマ区切り文字列として展開する」等。

**[P0-2] ルーティング定義の `confidence` 出力仕様が未定義**
- **対象セクション**: 5.3 ルーティング定義 > routing_rules.yaml
- **内容**: `output_routing.by_confidence` で `high / medium / low` の 3 段階を定義しているが、`interest_filter` ステージの `output` は `[interested, confidence]` とだけ記載されており、`confidence` がどのような値を取るのか（数値 0-1 のスコアなのか、列挙値 `high/medium/low` なのか）が定義されていない。LLM の出力を `high/medium/low` にマッピングするルールが存在しないため、テンプレート側の system プロンプトに「`confidence` を `high/medium/low` のいずれかで出力せよ」と書くのか、それとも数値スコアをルーティングロジックで閾値判定するのかが不明である。ルーティング定義が SoT であると主張するなら、この判定基準の定義は必須である。
- **修正の期待値**: `confidence` の出力形式（列挙値 or 数値スコア）と、数値の場合は `high/medium/low` へのマッピング閾値を `routing_rules.yaml` の定義に追加すること。あるいは、本 RFC はテンプレート登録のみで判定ロジックの詳細定義は将来の実装 RFC で扱うと明示する場合は、routing_rules.yaml の `output_routing.by_confidence` セクションを「暫定定義」として位置づけ、その旨を明記すること。

**[P0-3] `interested=false` 時の挙動がパイプラインと矛盾する可能性**
- **対象セクション**: 5.3 ルーティング定義 > 設計のポイント、5.4 データフロー
- **内容**: RFC では「`interested=false` の場合は配信しない（保存のみ。既存の `src/commands/run-due.ts` のパイプラインには影響しない）」と記載しているが、これは論理的に矛盾している。現行の `run-due.ts` パイプラインは Collect → Upsert → Select → Mail の流れで動作し、Select フェーズでは未配信書籍を全て選択対象とする。将来 `interest_filter` が実装された場合、`interested=false` の書籍を「配信しない」ためには、Select ロジックまたはそれ以前のフェーズに何らかのフィルタリングが必要であり、既存パイプラインへの影響は確実に発生する。「影響しない」との記載は、本 RFC がテンプレート登録のみで実装を伴わないという意味であれば、表現が紛らわしく誤読を招く。
- **修正の期待値**: 「既存パイプラインには影響しない」が「本 RFC のスコープではコード変更を伴わないため、現時点では影響しない」という意味であることを明確化すること。あるいは、将来の実装時にパイプラインのどの箇所にフィルタリングが入るかの概要を 5.4 データフローに補記すること。

**[P1-1] `docs/ops.md` への追記内容が抽象的**
- **対象セクション**: 5.5 ドキュメント更新 > docs/ops.md
- **内容**: RFC では `docs/ops.md` に「テンプレート更新手順（変更 → テスト → レビュー）」「破壊的変更の禁止事項（必須構造、アンカー密度など）」を追記すると記載しているが、「アンカー密度」が何を指すか（テスト設計に `deep_thinking_fiction.system.md` の「アンカー密度 6〜10」とあるが定義がない）、「必須構造」の具体的な項目リストが不明である。運用ドキュメントとしては、破壊的変更を判定できるレベルの具体性が必要である。
- **修正の期待値**: 「アンカー密度」の定義と、各テンプレートの「必須構造」の具体的な判定基準を RFC 内に記載するか、テンプレート本文登録時にその情報が元ネタ文章から自明に読み取れるのであれば、その旨を明記すること。

**[P1-2] 書籍タイプ分類が 3 種のみで十分か**
- **対象セクション**: 5.3 ルーティング定義 > book_type.yaml
- **内容**: 書籍タイプは `question`（問い型）、`dictionary`（辞書型）、`practice`（実践型）の 3 種のみ定義されている。しかしルーティング定義で特別扱いされるのは `dictionary` と `thinking_fiction`（思考型フィクション）であり、`thinking_fiction` は `book_type.yaml` に定義されていない。`thinking_fiction` は判定プロンプトによる分類結果（ブーリアン）であり書籍タイプ（カテゴリ）ではないという整理と思われるが、この区別が RFC 内で明示されていない。また、フィクション全般の扱いが書籍タイプに存在しない点も、将来の拡張時に混乱を招く可能性がある。
- **修正の期待値**: `thinking_fiction` が書籍タイプ分類ではなく判定プロンプトによる属性判定であることを明示的に記載すること。書籍タイプとプロンプト判定属性の関係を整理し、概念の混同を防ぐこと。

**[P1-3] テンプレートファイル数 16 の根拠が不明確**
- **対象セクション**: 5.1 ディレクトリ構成、9 実装・リリース計画
- **内容**: ディレクトリ構成では 16 ファイル（判定 3 種 x 2 = 6、Editorial 5 種 x 2 = 10）を配置するとあり、検証方法でも「16 ファイルが存在すること」を確認するとしている。しかし 5.2 の表を数えると判定プロンプト群は 3 種、Editorial テンプレート群は 5 種で合計 8 種 x 2（system/user）= 16 となるが、ディレクトリ構成のファイル一覧を数えると確かに 16 ファイルある。整合は取れているが、「判定プロンプト群（6ファイル）」「Editorial テンプレート群（10ファイル）」という記述が 9 章の実装計画にのみ登場し、5.1 と 5.2 の対応が一目で分かりにくい。
- **修正の期待値**: 5.1 または 5.2 に「合計 16 ファイル（判定 3 種 x 2 + Editorial 5 種 x 2）」のサマリを追記すると可読性が向上する。軽微なため対応は任意である。

**[P1-4] テストの配置場所の整合性**
- **対象セクション**: 5.6 テスト設計
- **内容**: テストファイルは `test/templates/templates.test.ts` に配置するとあるが、既存のテストは `test/db/`, `test/commands/`, `test/services/` のように機能ドメイン別のディレクトリ構成を取っている。`test/templates/` という新ディレクトリの追加は既存の規約に沿っており問題はないが、テンプレートファイルの読み込みパスが `templates/` であるのに対しテストが `test/templates/` に配置される点は、ディレクトリ名の衝突こそないが、将来テンプレート関連のユーティリティコードが増えた際に `src/templates/` と混同する可能性がある。
- **修正の期待値**: 特に対応は不要であるが、将来テンプレート関連の実装コードが `src/templates/` に配置される場合は、テストディレクトリとの命名整合性を意識すること。
