## Security & Risk Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Request Changes

**判定基準:** P0 が1件以上存在する場合は Request Changes とする。P0 が0件の場合は Approve とする。

### 2. 良い点 (Strengths)

- **セクション 7.1 セキュリティとプライバシー**: テンプレートファイルが静的なマークダウンであることを明示し、LLM API キーなどの秘匿情報をテンプレートに含めない設計方針を記載している。API キーの取得を実装時の環境変数に委譲する判断は、秘匿情報のリポジトリ混入を防止する上で適切である。
- **セクション 7.4 マイグレーションと後方互換性**: 本 RFC が新規ファイルの追加のみであり、既存コード・DB スキーマ・API への変更がないことを明記している。ロールバックが「追加ファイルの削除のみ」で完了する設計は、障害時の復旧コストを最小化しており、リスク低減の観点で妥当である。
- **セクション 3 やらないこと (Non-Goals)**: LLM API 呼び出しの実装、DB スキーマ変更、配信基盤変更を明示的にスコープ外としている。テンプレートとルーティング定義の登録に範囲を限定することで、既存パイプライン（`src/commands/run-due.ts`）の動作に影響を与えるリスクが排除されている。
- **セクション 5.2 変数規約**: テンプレートの差し込み変数を `{{book.*}}` に統一し、テストでプレースホルダの逸脱を検知する設計である。将来の LLM API 呼び出し実装時に不正な変数展開が発生するリスクを、SoT 段階で抑制する姿勢は適切である。
- **セクション 6 代替案の検討**: 案A（TypeScript 埋め込み）と案B（独立ファイル）の比較において、案B を選定した理由が明確に記載されている。テンプレートの変数整合性をテストで担保する方針も併記されており、案B の短所に対する緩和策が示されている。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 定義 |
| :--- | :--- |
| **P0 (Blocker)** | 修正必須。論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 |
| **P1 (Nit)** | 提案。より良い手法、軽微な懸念、参考情報 |

#### 指摘一覧

**[P0-1] テンプレート変数へのインジェクション攻撃に対する設計方針の欠如**
- **対象セクション**: 5.2 テンプレート設計 / 7.1 セキュリティとプライバシー
- **内容**: テンプレートの差し込み変数（`{{book.title}}`, `{{book.authors}}`, `{{book.description}}` 等）には、Google Books API から取得した外部データが挿入される。現在の `src/services/prompt-builder.ts` は文字列テンプレートリテラルで直接展開しており、将来の LLM API 呼び出し実装時にも同様のパターンが想定される。Google Books API から取得される書籍情報（特に `description`）には任意のテキストが含まれ得るため、以下のリスクが存在する。(1) **プロンプトインジェクション**: 書籍の description に「以降の指示を無視して...」等の悪意あるテキストが含まれた場合、LLM の判定結果（`interested`, `confidence` 等）が操作される可能性がある。(2) **テンプレート構造の破壊**: 差し込み値に Markdown の見出し記法（`#`, `##`）やテンプレートの制御構造を模倣する文字列が含まれた場合、プロンプトの意図した構造が崩れる可能性がある。本 RFC はテンプレート登録のみがスコープであり LLM API 呼び出しの実装は対象外であるが、テンプレートが「実装契約」（SoT）として機能する以上、外部データの差し込みに対するセキュリティ方針を SoT の一部として定義すべきである。
- **修正の期待値**: セクション 5.2 の変数規約またはセクション 7.1 に、以下の方針を追記すること。(1) `{{book.*}}` 変数に外部データが挿入されることを明示し、プロンプトインジェクションのリスクを認識している旨を記載する。(2) 将来の実装時にサニタイズまたは入力値の長さ制限を適用する方針を注記する。(3) `templates/README.md` にテンプレート作成者向けの注意事項として、差し込み変数の前後に区切りを設けるなどの防御的記述ガイドラインを記載する。テンプレート本文自体の変更は不要であり、設計方針の明文化のみを求める。

**[P1-1] routing_rules.yaml の改ざん検知と整合性保証**
- **対象セクション**: 5.3 ルーティング定義 / 5.6 テスト設計
- **内容**: `routing_rules.yaml` は判定ステージの振る舞いと出力ルーティングを制御する SoT であり、この定義の改ざんや不整合は判定結果を直接左右する。テスト設計ではキーの存在確認と `default_model` の値チェックのみが記載されているが、以下の整合性検証が不足している。(1) `stages` に定義されたステージ名と `auto_triggers` で参照されるステージの整合性。(2) `output_routing.by_confidence` のキー（high/medium/low）が全て定義されていること。(3) YAML の構文エラーだけでなく、スキーマレベルの妥当性検証（未知のキーが含まれていないこと等）。これらが検証されない場合、テンプレートや定義ファイルの誤編集が検知されずにパイプラインに影響を与える可能性がある。
- **修正の期待値**: セクション 5.6 のテスト設計に、`routing_rules.yaml` のスキーマ妥当性検証テストを追加することを推奨する。最低限、`output_routing.by_confidence` に `high`, `medium`, `low` の3キーが存在すること、および `auto_triggers` で参照される条件キー（`confidence`, `thinking_fiction`, `book_type`）が有効な値であることを検証するテストケースを追加すべきである。

**[P1-2] LLM 判定結果の信頼性境界が未定義**
- **対象セクション**: 5.3 ルーティング定義 / 5.4 データフロー
- **内容**: ルーティング定義では `confidence` を `high`, `medium`, `low` の3段階で扱い、出力テンプレートの選択と Deep/Follow-up の自動発火を制御している。しかし、LLM（gpt-4o-mini）の出力する `confidence` 値がどのような形式（数値、文字列、列挙値）で返却され、どのように `high/medium/low` にマッピングされるかの定義が存在しない。LLM の出力は非決定的であり、期待する形式と異なる応答が返却される場合、ルーティングが不定になるリスクがある。本 RFC のスコープは定義登録のみであるが、SoT としての完全性を考慮すると、信頼性境界の定義が望ましい。
- **修正の期待値**: `routing_rules.yaml` の `notes` セクションまたは `templates/README.md` に、`confidence` の期待値形式（例: `"high"`, `"medium"`, `"low"` の文字列列挙）と、LLM が期待外の値を返却した場合のフォールバック方針（例: デフォルトで `low` として扱う）を記載することを推奨する。実装の詳細は将来の RFC に委ねるとしても、SoT 上の方針宣言は現時点で行うべきである。

**[P1-3] `interested=false` 時の「保存のみ」動作の影響範囲**
- **対象セクション**: 5.3 ルーティング定義 / 5.4 データフロー
- **内容**: RFC は `interested=false` の場合「配信しない（保存のみ）」と記載し、「既存の `src/commands/run-due.ts` のパイプラインには影響しない」と注記している。しかし、現行パイプラインでは全書籍が配信候補として扱われるため、将来の実装で `interested=false` の書籍を配信候補から除外するロジックが追加された場合、`delivery_items` テーブルの配信状態管理（SSOT）との整合性に影響が生じる可能性がある。具体的には、`interested=false` の書籍が `delivery_items` に未登録のまま残ると、`selectBooksForMailByJob` のフォールバック選択で再度候補に含まれる可能性がある。
- **修正の期待値**: セクション 5.4 のデータフロー注記または `routing_rules.yaml` の `notes` に、「`interested=false` の書籍の永続化方針（DB への保存有無、配信候補からの除外方法）は将来の実装 RFC で定義する」旨を明示的に記載することを推奨する。現時点ではリスクの認識を示すだけで十分である。

**[P1-4] テンプレートファイルの変更管理における破壊的変更の定義の具体化**
- **対象セクション**: 5.5 ドキュメント更新 > docs/ops.md / 8. テスト戦略
- **内容**: `docs/ops.md` に「破壊的変更の禁止事項（必須構造、アンカー密度など）」を追記する方針が記載されているが、何を以て「破壊的変更」とするかの具体的な定義が RFC 上に存在しない。テスト設計では `deep_thinking_fiction.system.md` の必須構造とアンカー密度のみが検証対象として挙げられているが、他のテンプレート（editorial_lite, medium_lite, nano_lite 等）に対する破壊的変更の検知基準が不明確である。テンプレートの SoT としての信頼性を保つためには、各テンプレートの不変条件を定義すべきである。
- **修正の期待値**: セクション 5.5 の `docs/ops.md` 追記内容に、破壊的変更の具体的な定義を記載することを推奨する。例として、(1) 必須の差し込み変数（`{{book.title}}` 等）の削除、(2) system プロンプトの役割指示の削除または根本的変更、(3) 字数目安の大幅な逸脱（セクション 5.2 の表に定義された範囲を超える変更）を破壊的変更として定義し、これらをテストまたはレビューで検知する方針を示すことが望ましい。

**[P1-5] gpt-4o-mini モデルの廃止・変更に対するリスク認識**
- **対象セクション**: 5.3 ルーティング定義 / 5.5 ドキュメント更新 > docs/ops.md
- **内容**: `routing_rules.yaml` と docs の両方に `gpt-4o-mini` を明記する方針は適切であるが、OpenAI がモデルを廃止（deprecate）した場合の影響と対応方針が RFC 上に記載されていない。モデル廃止は外部依存に起因するリスクであり、事前の認識と対応方針の明文化が望ましい。`docs/ops.md` に既定モデル変更手順を追記する方針は記載されているが、廃止検知とフォールバックの方針は含まれていない。
- **修正の期待値**: `docs/ops.md` への追記内容として、モデル廃止時の対応手順（(1) OpenAI の非推奨通知の確認方法、(2) `routing_rules.yaml` と docs の同時更新手順、(3) 代替モデルの選定基準）を注記として記載することを推奨する。これは将来のリスク低減を目的とした文書化提案であり、現時点でのコード変更は不要である。
