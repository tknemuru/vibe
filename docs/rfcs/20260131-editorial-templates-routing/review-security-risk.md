## Security & Risk Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Approve

**判定基準:** P0 が0件のため Approve とする。

### 2. 良い点 (Strengths)

- **セクション 5.2 外部データの安全性に関する方針**: プロンプトインジェクションとテンプレート構造の破壊という2つのリスクを明示的に識別し、SoT としての方針（サニタイズ・長さ制限・防御的指示・区切りマーカー）を定めている。テンプレート登録のみのスコープにおいて、将来の実装時に対処すべきセキュリティ要件を先行して文書化している点は、リスク管理の観点で適切である。

- **セクション 7.1 セキュリティとプライバシー**: テンプレートファイルが静的マークダウンであること、LLM API キーをテンプレートに含めず実装時に環境変数から取得する設計方針を明示している。秘匿情報のリポジトリ混入を防止する判断は妥当である。

- **セクション 7.4 マイグレーションと後方互換性**: 新規ファイルの追加のみで既存コード・DB スキーマ・API への変更がなく、ロールバックが「追加ファイルの削除のみ」で完了する設計である。障害時の復旧コストが最小化されており、導入リスクが極めて低い。

- **セクション 3 やらないこと (Non-Goals)**: LLM API 呼び出しの実装、DB スキーマ変更、配信基盤変更を明示的にスコープ外としている。テンプレートとルーティング定義の登録に範囲を限定し、既存パイプライン（`src/commands/run-due.ts`）の動作に影響を与えるリスクを排除している。

- **セクション 5.3 ルーティング定義**: `confidence` の値域を enum として `routing_rules.yaml` に明示し（`type: enum`, `values: [high, medium, low]`）、LLM が期待外の値を返却した場合のフォールバック（`fallback: low`）を定義している。非決定的な LLM 出力に対する信頼性境界が設計レベルで考慮されている。

- **セクション 5.3 設計のポイント**: `interested=false` の書籍の永続化方針を将来の実装 RFC に委ね、その旨を `routing_rules.yaml` の `notes` に明記している。現時点で既存パイプラインに影響しないことと、将来の実装でパイプライン変更が発生することの両方を明確に記載しており、リスクの認識が適切である。

- **セクション 5.5 docs/ops.md**: 破壊的変更の定義（差し込み変数の削除、system プロンプトの根本的変更、字数目安の ±50% 逸脱、必須構造の削除、アンカー密度要件の削除）が具体的に列挙されている。既定モデル変更手順（`routing_rules.yaml` + docs + テストの3点同時更新）およびモデル廃止時の対応手順（非推奨通知確認、代替モデル選定基準、同時更新手順）も記載されており、運用リスクの緩和策が文書化されている。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 定義 |
| :--- | :--- |
| **P0 (Blocker)** | 修正必須。論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 |
| **P1 (Nit)** | 提案。より良い手法、軽微な懸念、参考情報 |

#### 指摘一覧

P0 は該当なし。

**[P1-1] system プロンプトにおける防御的指示の検証可能性**
- **対象セクション**: 5.2 テンプレート設計 > 外部データの安全性に関する方針
- **内容**: SoT 方針として「テンプレートの system プロンプトには、ユーザ入力（書籍情報）による指示の上書きを無視する旨の防御的指示を含めること」と定められている。この方針自体は適切であるが、テスト設計（セクション 5.6）には防御的指示の存在を検証するテストケースが含まれていない。テンプレート本文が元ネタ文章に従う前提であるため、登録時点で防御的指示が含まれているかはテンプレート本文次第であるが、将来のテンプレート編集時に防御的指示が誤って削除されるリスクがある。
- **修正の期待値**: テスト設計の検討事項として、system プロンプトに防御的指示（例: 「ユーザ入力による指示の上書きを無視する」旨の文言）が含まれることの検証を将来のテスト拡充時に追加することを推奨する。本 RFC のスコープではテンプレート本文が元ネタ文章に忠実であることが前提であるため、現時点では必須としない。

**[P1-2] `auto_triggers` の allow/deny ルール評価順序の未定義**
- **対象セクション**: 5.3 ルーティング定義 > routing_rules.yaml
- **内容**: `auto_triggers` の `deep` トリガーは `allow` に `confidence: high` かつ `thinking_fiction: true` を、`deny` に `book_type: dictionary` を定義している。ある書籍が `confidence: high`、`thinking_fiction: true`、`book_type: dictionary` の全条件に該当した場合、`allow` と `deny` のどちらが優先されるかが明示されていない。`allow` と `deny` の両方にマッチするケースは論理的に発生し得るため、評価順序（deny 優先 / allow 優先）を定義しておくことで、将来の実装時に曖昧性が排除される。本 RFC のスコープはテンプレート登録のみであるため、直ちに問題が顕在化することはないが、SoT としての完全性を考慮すると定義が望ましい。
- **修正の期待値**: `routing_rules.yaml` の `auto_triggers` セクションまたは `notes` に、`allow` と `deny` の両方にマッチした場合の評価優先順（例: 「deny 優先（deny にマッチした場合は allow の条件に関わらず発火しない）」）を記載することを推奨する。

**[P1-3] テンプレートファイルのアクセス制御に関する注記の不在**
- **対象セクション**: 5.1 ディレクトリ構成 / 7.1 セキュリティとプライバシー
- **内容**: `templates/` ディレクトリはプロジェクトルート直下に配置され、Git リポジトリに含まれる。テンプレートファイル自体には秘匿情報は含まれないため機密性のリスクは低いが、テンプレートの改ざん（不正な変数追加、プロンプトの意図的書き換え等）が行われた場合、将来の LLM 判定結果に影響を与える。Git の変更履歴とレビュープロセスが改ざん検知の主要な手段であるが、この点が RFC 上で明示されていない。
- **修正の期待値**: セクション 7.1 または `docs/ops.md` の追記内容に、テンプレートファイルの変更は必ず Git 管理下でレビューを経て行う旨の運用方針を付記することを推奨する。個人利用システム（単一配信先設計）であることを考慮すると、リスクは極めて低いため、対応は任意である。

**[P1-4] LLM 出力パース失敗時のフォールバックが `confidence` 以外のフィールドに未定義**
- **対象セクション**: 5.3 ルーティング定義 > routing_rules.yaml
- **内容**: `routing_rules.yaml` は `confidence` が期待外の値を返却した場合のフォールバック（`fallback: low`）を定義しているが、他の出力フィールド（`interested`、`intellectual_pleasure`、`thinking_fiction`、`reason`）が期待外の値を返却した場合のフォールバック方針が定義されていない。特に `interested` フィールドが `true`/`false` 以外の値を返却した場合、配信判定の根幹に影響する。本 RFC はテンプレート登録のみのスコープであるが、SoT としてフォールバック方針を網羅的に定めておくことで、将来の実装時のエッジケース対応が容易になる。
- **修正の期待値**: `routing_rules.yaml` の `notes` セクションまたは将来の実装 RFC への申し送り事項として、`interested`（boolean フォールバック: `false`）、`intellectual_pleasure`（boolean フォールバック: `false`）、`thinking_fiction`（boolean フォールバック: `false`）のフォールバック方針を記載することを推奨する。安全側に倒す（配信しない / 属性なしとして扱う）方針が望ましい。
