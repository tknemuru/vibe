# DRE Book Collector 改修 指示書（Claude Code 用・完全版）

## ゴール（この改修で達成すること）
1) iPhone（Gmailアプリ）でメールを見たときに、各書籍の「Copy」リンクをタップ → ブラウザでワンタップで Deep Research 用テキストをクリップボードにコピーできること。
2) Deep Research に投げるコピー対象から「説明（description）」は除外すること（メール閲覧用には表示しても良いが、コピー対象には混ぜない）。
3) 破壊操作の運用改善：
   - `dre db reset`（DB全クリア）を実装
   - `dre mail reset`（配信状態だけクリア）を実装
4) 鮮度要件は低いので、鮮度ロジック（例：7日縛り等）は簡素化/撤廃し、取得件数上限を増やしやすくする。
5) テストコードを必ず追加し、既存機能も含めて回帰テストを整備する。
6) JSDocはすべて日本語に統一する（英語禁止）。

---

## Global Permission（包括的事前許可）
以下の作業はすべてユーザーが事前に許可します。確認プロンプトを挟まず、Plan通りに実行してください。

- 既存ファイルの編集・削除・リネーム
- SQLite DB スキーマの変更・再作成
- config / docs / templates の更新
- 既存機能（ranker / feedback / summarize 等）の削除
- 新規ファイル・ディレクトリの作成
- 既存テストが無い/少ない状態からのテスト基盤導入

※ただし破壊的コマンド（db reset等）は CLI 仕様として `--yes` か対話確認を必須にしてください（エンドユーザー保護のため）。

---

## Quality Gate: テストとJSDoc（必須）

### テスト（必須）
- この改修では、既存機能を含めて必ずテストを追加すること。
- 「テストが増えていない変更」は未完了として扱う。
- 外部API/SMTPは実呼び出ししない。モック/スタブで境界をテストする。

#### 最小必須テスト（ユニット）
1) due判定（interval / last_success_at）
2) Selector: 未配信優先 + 0件回避フォールバック
3) DB: isbn13 upsert（重複排除）
4) dre mail reset: --since / --job の対象範囲が正しい
5) dre db reset: bak作成 + 新規初期化が正しい

#### 最小必須テスト（統合）
- temp SQLite（またはtmpファイル）で run-due を実行し、
  collect（スタブ）→select→mail（モック）→deliveries保存→last_delivered_at更新
  が通ること。

#### Verify（必須）
- `npm test`
- `npm run build`
- 失敗時は修正してから次Taskへ進むこと。

### JSDoc（必須）
- すべてのJSDocは日本語で書くこと（英語禁止）。
- 型定義/主要関数/DB操作/コマンド処理には必ずJSDocを付けること。
- 目的/引数/戻り値/失敗条件/副作用を最低限含めること。
- 既存の英語JSDocも、この改修でまとめて日本語に置換すること。

### Task完了時の報告（必須）
各Task完了時に以下を報告：
- 変更ファイル一覧
- 追加/更新したテスト一覧（ファイル名と担保内容）
- Verify結果（build/test の結果要約）
- 残課題

---

## 実装方針（重要な仕様）
### 1) メール本文のコピー対象は「prompt_text」のみ
- `prompt_text`（Deep Research に投げるテキスト）から description は必ず除外。
- メール閲覧用のカードには description を表示してもよいが、コピー対象（prompt_text）に混ぜない。

### 2) Gmail iOS で「リンク→即コピー」を満たすため、メール内JSは使わない
- メール本文だけでワンクリックコピーはできない。
- メールには「Copy」リンク（URL）を置き、リンク先のWebページで `navigator.clipboard.writeText()` をユーザー操作（タップ）に紐づけて実行する。

### 3) Copyページはローカル `dre serve` で提供（MVP）
- `dre serve --host 0.0.0.0 --port 8787` のように起動できる。
- `GET /p/:token` を実装し、tokenから prompt_text を取得して表示＆コピー可能にする。
- UIはモバイル最優先（大きいCopyボタン、成功トースト）。

### 4) トークンでアクセス制御
- `prompts`（prompt本文）と `prompt_tokens`（token→prompt紐付け）をDBに保存する。
- tokenは推測困難なランダム文字列。
- 有効期限（expires_at）を持たせる（デフォルト例：30日）。期限切れは 410/404 などで扱う。

### 5) 運用改善コマンド
- `dre db reset [--yes]`：DBを `.bak` に退避して再初期化
- `dre mail reset [--job <name>] [--since <duration>] [--yes]`：
  - booksの `last_delivered_at` を NULL に戻す（= 未配信へ戻す）
  - 重複排除（isbn13）自体は維持

### 6) 0件ストレス回避
- Selectorは未配信優先。
- 未配信が0件ならフォールバック（例：last_seen_atが新しい順にK件）でメールを空にしない。

---

## 実行計画（Tasks）

### Task 0: 現状把握 & Plan Mode（必須）
- リポジトリ構造、既存コマンド、DB層、メールテンプレ、テスト基盤の有無を確認。
- 以降のタスクでどのファイルを変更するか、最初に短く列挙してから着手。

DoD:
- 変更候補のファイル/ディレクトリ一覧が出ていること。

Verify:
- なし（調査のみ）

Rollback:
- なし

---

### Task 1: テスト基盤の導入（最優先）
- 既存に合わせて Jest or Vitest を採用し、`npm test` を動かす。
- `test/helpers` に temp SQLite 作成、mail送信モック等を用意。
- 以降のTaskで必ずテストを足せる土台を作る。

DoD:
- `npm test` が動く（最低1つのサンプルテストが通る）

Verify:
- `npm test`

Rollback:
- 追加した依存と設定を戻せるコミット単位にする

Risks:
- 既存ビルドと競合 → 最小構成で入れる

---

### Task 2: DBスキーマ & DAO（prompt保存/トークン）
- `prompts` と `prompt_tokens` テーブル追加（または既存exportsを流用しつつtoken表を追加）。
- DAO追加：
  - createPrompt(isbn13, prompt_text) -> prompt_id
  - issueToken(prompt_id, expires_at) -> token
  - getPromptByToken(token) -> prompt_text（期限切れ判定含む）
- 併せて books の配信状態（last_delivered_at）操作も整理。

DoD:
- token→prompt_text を取得できる

Verify:
- ユニットテスト：token発行と期限切れ挙動

Rollback:
- migrationを戻せる手順/コミットにする

---

### Task 3: Prompt Builder 分離（description除外）
- `buildDeepResearchPrompt(book)` を追加し、必ず description を含めない。
- メール表示用（カード）とコピー用（prompt_text）を型/変数で明確に分ける（混在防止）。

DoD:
- prompt_textにdescriptionが入らないことがテストで保証される

Verify:
- ユニットテスト

Rollback:
- 旧テンプレ参照に戻せる

---

### Task 4: Selector の0件回避フォールバック
- 未配信（last_delivered_at IS NULL）優先で mail_limit 件。
- 未配信が0件なら last_seen_at の新しい順にK件（既配信含む）を返す。

DoD:
- DB状況に関わらずメールが空になりにくい

Verify:
- ユニットテスト（未配信0ケース）

Rollback:
- フォールバックを設定でOFFにできるようにしても良い

---

### Task 5: Mailer テンプレ更新（Copyリンク埋め込み）
- メール本文に各書籍の「Copy」リンクを付ける：
  - 例：`http://<host>:<port>/p/<token>`
- メール本文の“コピー対象”は表示しない or 最小化してよい（リンク主導）。
- descriptionは閲覧用としてカード内に残して良い（コピー対象にはしない）。

DoD:
- iPhone Gmail でリンクを開ける（リンクが機能する）

Verify:
- ローカルでメール生成（HTML）を確認（送信はモック可）

Rollback:
- リンクを消して従来表示に戻せる

---

### Task 6: `dre serve` 実装（Copyページ）
- `dre serve` コマンドを追加し、HTTPサーバを起動できること。
- `GET /p/:token`：
  - token検証/期限チェック
  - prompt_textだけを表示
  - 「Copy」ボタン（タップで clipboard write）
  - 成功トースト表示
- セキュリティ：
  - prompt_text のみ表示（description等は出さない）
  - tokenが無効/期限切れなら 404/410

DoD:
- モバイルでワンタップコピーが動作

Verify:
- ルートの統合テスト（token→200/410/404）
- 手動確認（ブラウザでボタン押下）

Rollback:
- serveをfeature flagでOFFにできる（任意）

---

### Task 7: コマンド追加（db reset / mail reset）
- `dre db reset [--yes]`
  - data/app.db -> data/app.db.bak へ退避（存在する場合）
  - 新規DB初期化
- `dre mail reset [--jo]()
